<%- include('partials/head', { title: 'Transactions: ' + category + ' (' + year + '-' + month + ')' }) %>
<h1>Transactions for <%= category %> in <%= year %>-<%= month %></h1>
<p><a href="/years/<%= year %>/<%= month %>">← Back to month summary</a></p>
<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Amount</th>
      <th>Notes</th>
      <th>Category</th>
    </tr>
  </thead>
  <tbody>
    <% transactions.forEach(function(tx) { %>
      <tr>
        <td><%= tx.date || '' %></td>
        <td><%= tx.description || '' %></td>
        <td><%= fmtCurrency(tx.amount, currency) %></td>
        <td><%= tx.notes || '' %></td>
        <td>
          <div style="display:flex; align-items:center; gap:0.5em;">
            <select data-idx="<%= tx._idx %>">
              <% allCategories.forEach(function(cat) { %>
                <option value="<%= cat %>" <%= cat === tx.category ? 'selected' : '' %>>
                  <%= cat %>
                </option>
              <% }); %>
            </select>
            <span class="update-status" data-idx="<%= tx._idx %>"></span>
          </div>
        </td>
      </tr>
    <% }); %>
  </tbody>
</table>
<%- include('partials/footer') %>
<script>
  document.querySelectorAll('select[data-idx]').forEach((sel) => {
    sel.addEventListener('change', async () => {
      const idx = sel.getAttribute('data-idx');
      const category = sel.value;
      const status = document.querySelector(`.update-status[data-idx=\"${idx}\"]`);
      sel.disabled = true;
      status.textContent = '⌛';
      try {
        const resp = await fetch(`/manage/transaction/${idx}/category`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category }),
        });
        status.textContent = resp.ok ? '✓' : '✗';
      } catch {
        status.textContent = '✗';
      }
      sel.disabled = false;
      setTimeout(() => { status.textContent = ''; }, 2000);
    });
  });
</script>